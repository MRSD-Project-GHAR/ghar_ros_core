
<launch>
    <arg name="robot_name"                        default="locobot"/>
    <arg name="rviz"                              default="true"/>
    <arg name="rtabmap_viz"                       default="true"/>
    <arg name="database_path"                     default="~/.ros/rtabmap.db"/>
    <arg name="localization"                      default="false"/>
    <arg name="delete_db_on_start"                default="true" />
    <arg name="use_sim_time"                      default="true"/>
    <param if="$(arg use_sim_time)" name="use_sim_time" value="true"/>

    <arg name="rtabmap_args"                      default=""/>
    <arg name="rtabmapviz_args"                   default=""/>
    <arg name="frame_id"                          default="camera_link"/>
    <arg name="rviz_cfg"                          default="$(find rtabmap_launch)/launch/config/rgbd.rviz" />
    <arg name="tag_topic"                         default="/tag_detections" />       <!-- apriltags async subscription -->
    <arg name="tag_linear_variance"               default="0.0001" />
    <arg name="tag_angular_variance"              default="9999" />                  <!-- >=9999 means ignore rotation in optimization, when rotation estimation of the tag is not reliable -->
    <arg name="fiducial_topic"                    default="/fiducial_transforms" />  <!-- aruco_detect async subscription, use tag_linear_variance and tag_angular_variance to set covriance -->
    <arg name="stereo"                            default="true"/>
    <!-- TF FRAMES -->
    <!-- <node pkg="tf" type="static_transform_publisher" name="world_to_world_map"
          args="0.0 0.0 0.0 0.0 -0.7071068 0.7071068 0.0  /world /world_map 100" />
    
    <node pkg="tf" type="static_transform_publisher" name="world_map_to_map"
          args="-4.45 -6.18 0.0 0.0 0.0 0.0 1.0 /world_map /map 100" /> -->

    
    <node pkg="tf" type="static_transform_publisher" name="world_to_map"
          args="4.45 0.0 6.18 0.0 -0.7071068 0.7071068 0.0 /world /map 100" />

    <arg name="rtabmap_custom_args" default="$(arg rtabmap_args)
                                            --Optimizer/Strategy 1 
                                            --Optimizer/PriorsIgnored false 
                                            --RGBD/MarkerDetection true
                                            --Marker/Dictionary 16
                                            --Marker/Length 0.25
                                            --RGBD/StartAtOrigin false"/>
                                        

  <group ns="rtabmap">
    <!-- Odometry -->
    <node name="cam_odometry" pkg="rtabmap_odom" type="stereo_odometry" output="screen">
      <remap from="left/image_rect"   to="/camera/infra1/image_rect_raw"/>
      <remap from="right/image_rect"  to="/camera/infra2/image_rect_raw"/>
      <remap from="left/camera_info"  to="/camera/infra1/camera_info"/>
      <remap from="right/camera_info" to="/camera/infra2/camera_info"/>
      <param name="frame_id"          value="camera_link"/>
      <!-- <remap from="imu"               to="/rtabmap/imu"/> -->
      <param name="wait_imu_to_init"  value="false"/>
    </node>

    <!-- Visual SLAM -->
    <node name="rtabmap" pkg="rtabmap_slam" type="rtabmap" output="screen" args="$(arg rtabmap_custom_args)">
      <param name="delete_db_on_start"   value="$(arg delete_db_on_start)"/>
      <param name="localization"         value="$(arg localization)"/>
      <!-- <param name="subscribe_depth" type="bool" value="true"/> -->
      <param name="frame_id" type="string" value="$(arg frame_id)"/>
      <!-- <param name="Marker/Priors" type="string" value="100 -7.1 3.2 0.55 1.5707963 1.5707963 0" /> -->
      
      <param name="subscribe_stereo"     type="bool"   value="$(arg stereo)"/>
      <remap from="left/image_rect"        to="/camera/infra1/image_rect_raw"/>
      <remap from="right/image_rect"       to="/camera/infra2/image_rect_raw"/>
      <remap from="left/camera_info"       to="/camera/infra1/camera_info"/>
      <remap from="right/camera_info"      to="/camera/infra2/camera_info"/>

   
      <remap from="rgb/camera_info" to="/camera/color/camera_info"/>
      <remap from="global_pose" to="/global_pose"/>
      <param name="ground_truth_frame_id" type="string" value="world"/>

      <remap from="tag_detections"         to="$(arg tag_topic)"/>
      <!-- <param name="ground_truth_base_frame_id" type="string" value="kinect_gt"/> -->
      <param name="landmark_linear_variance"   type="double" value="$(arg tag_linear_variance)"/>
      <param name="landmark_angular_variance"  type="double" value="$(arg tag_angular_variance)"/>
      
    </node>

    <!-- Visualisation  -->
    <node if="$(arg rtabmap_viz)" pkg="rtabmap_viz" type="rtabmap_viz" name="rtabmap_viz" args="-d $(find rtabmap_examples)/launch/config/rgbd_gui.ini" output="screen">
      <param name="subscribe_depth" type="bool" value="true"/>
      <param name="subscribe_odom_info" type="bool" value="true"/>
      <param name="queue_size" type="int" value="30"/>

      <remap from="rgb/image" to="/camera/color/image_raw"/>
      <!-- <remap from="depth/image" to="/camera/aligned_depth_to_color/image_raw"/> -->
      <remap from="rgb/camera_info" to="/camera/color/camera_info"/>
    </node>

    <node if="$(arg rviz)" pkg="rviz" type="rviz" name="rviz" args="-d $(arg rviz_cfg)"/>


  </group>        

</launch>
