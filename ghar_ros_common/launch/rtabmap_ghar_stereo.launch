
<launch>
    <arg name="robot_name"                        default="locobot"/>
    <arg name="rviz"                              default="false"/>
    <arg name="rtabmap_viz"                       default="false"/>
    <arg name="database_path"                     default="~/.ros/rtabmap_nsh_4th.db"/>
    <arg name="localization"                      default="true"/>
    <arg name="delete_db_on_start"                default="true" />
    <arg name="use_sim_time"                      default="false"/>
    <param if="$(arg use_sim_time)" name="use_sim_time" value="true"/>

    <arg name="rtabmap_args"                      default=""/>
    <arg name="rtabmapviz_args"                   default=""/>
    <arg name="frame_id"                          default="camera_link"/>
    <arg name="rviz_cfg"                          default="$(find rtabmap_launch)/launch/config/rgbd.rviz" />
    <arg name="tag_topic"                         default="/tag_detections" />       <!-- apriltags async subscription -->
    <arg name="tag_linear_variance"               default="0.0001" />
    <arg name="tag_angular_variance"              default="9999" />                  <!-- >=9999 means ignore rotation in optimization, when rotation estimation of the tag is not reliable -->
    <arg name="fiducial_topic"                    default="/fiducial_transforms" />  <!-- aruco_detect async subscription, use tag_linear_variance and tag_angular_variance to set covriance -->
    <arg name="stereo"                            default="true"/>
    <!-- TF FRAMES -->
    <!-- Identity Matrix because we fixed the world and map to be the same. Map is not the robot starting poing anymore -->
    <node pkg="tf" type="static_transform_publisher" name="world_to_map"
          args="0.0 0.0 0.0 0.0 0.0 0.0 1.0 /world /map 100" />
      
    <arg name="rtabmap_custom_args" default="$(arg rtabmap_args)
                                            --Optimizer/Strategy 1 
                                            --Optimizer/PriorsIgnored false 
                                            --RGBD/MarkerDetection true
                                            --Marker/Dictionary 16
                                            --Marker/Length 0.25
                                            --RGBD/StartAtOrigin false"/>
                                        
  <group ns="rtabmap">
    <!-- Odometry -->
    <node name="cam_odometry" pkg="rtabmap_odom" type="stereo_odometry" output="screen" respawn="true">
      <remap from="left/image_rect"   to="/camera/infra1/image_rect_raw"/>
      <remap from="right/image_rect"  to="/camera/infra2/image_rect_raw"/>
      <remap from="left/camera_info"  to="/camera/infra1/camera_info"/>
      <remap from="right/camera_info" to="/camera/infra2/camera_info"/>
      <param name="frame_id"          value="camera_link"/>
      <!-- <remap from="imu"               to="/rtabmap/imu"/> -->
      <param name="wait_imu_to_init"  value="false"/>
    </node>

    <!-- Visual SLAM -->
    <node name="rtabmap" pkg="rtabmap_slam" type="rtabmap" output="screen" args="$(arg rtabmap_custom_args)" respawn="true">
      <param name="delete_db_on_start"   value="$(arg delete_db_on_start)"/>
      <param name="database_path"        value="$(arg database_path)"/>
      <param name="localization"         value="$(arg localization)"/>
      <!-- <param name="subscribe_depth" type="bool" value="true"/> -->
      <param name="frame_id" type="string" value="$(arg frame_id)"/>
      <!-- Priors we have measured already -->
      <param name="Marker/Priors" type="string" value="100 -7.1000 3.2000 0.5500 1.5708 1.5708 -0.0000 | 110 -7.1039 2.1105 0.5310 1.5452 -2.7137 -2.0051 | 120 -7.1037 1.2013 0.5479 1.5319 -3.0018 -1.7308 | 130 -7.0957 0.1607 0.5341 1.5297 -2.8221 -1.9070 | 140 -7.1192 4.1828 0.5661 1.5586 -0.5559 2.0572 | 160 7.2295 3.4119 1.0827 -1.4451 0.2493 -1.2974 | 170 5.3703 6.3085 0.9793 -0.0191 1.6406 -0.1004 | 180 -4.9084 6.1765 0.0534 1.5045 -2.7038 -1.7807 | 200 -0.1268 6.4982 0.4818 -0.0030 1.7945 -0.0706 | 300 -5.6869 -1.1944 0.4648 -1.2870 -1.6396 3.1315 | 310 -5.2464 -0.4952 0.6008 -1.2978 -1.5865 -3.0695 | 320 -7.0053 -2.0148 0.5669 1.5111 -2.2859 -2.4290 | 330 -7.0345 -0.8889 0.5306 1.4979 -2.4790 -2.2319 | 350 -6.9829 -3.0462 0.5888 1.4943 -1.9087 -2.8102 | 360 -6.9272 -4.1144 0.5685 1.5257 -2.2200 -2.5021 | 370 -4.8068 -6.2160 0.6705 -0.0079 -1.5772 -3.0988 | 380 -3.8894 -6.2196 0.7285 0.0345 -1.5338 -3.1008 | 450 -2.9474 -6.3503 0.7703 0.1594 -1.5907 -3.0927 | 460 -2.1338 -6.5384 0.7263 0.1977 -1.6459 -3.1300 | 390 -3.2509 -3.8108 0.7256 0.0492 1.5860 -0.0247 | 400 -2.0884 -3.9057 0.7906 0.0120 1.5522 -0.0507 | 410 -1.1267 -3.9028 0.8634 -0.0137 1.5479 -0.0533 | 430 0.6212 -3.9275 0.9479 -0.0171 1.5591 -0.0315 | 440 1.3021 -3.9141 0.9814 0.0366 1.5862 -0.0295 | 480 2.0695 -3.9560 0.6666 0.0517 1.5835 0.0221 | 490 3.0013 -3.9615 0.6521 0.1026 1.4036 0.0478 | 470 -0.9634 -6.8032 0.7543 0.2780 -1.6545 -3.1167 | 150 7.4024 -5.5000 1.0230 -1.5108 0.6089 -0.9825 | 610 0.1667 -6.9369 0.8045 0.1523 -1.6828 -3.1051 | 620 1.1549 -7.0956 0.8159 0.1674 -1.6916 -3.1109 | 630 1.9588 -7.2053 0.8131 0.1646 -1.6797 -3.1255 | 640 5.3624 -0.8883 0.9860 1.5169 -3.1386 -1.5656 | 650 7.3791 -0.3694 1.0991 -1.5321 -0.5096 -2.0945 | 660 5.3555 -0.0114 1.0035 1.4988 3.0711 -1.4955 | 670 7.3672 0.5174 1.0983 -1.5282 0.1019 -1.4824 | 680 5.3704 0.8461 1.0128 1.5129 -3.1159 -1.5772 | 690 7.4074 1.4214 1.1351 -1.4754 0.6444 -0.9060 | 700 5.3746 1.7885 0.9774 1.4940 -3.0399 -1.6556 | 710 7.2811 2.4999 1.0885 -1.4598 0.4385 -1.1106 | 720 5.3632 2.7834 0.9589 1.4908 -3.0782 -1.6099 | 730 7.1827 4.2977 1.0914 -1.4567 0.3057 -1.2418 | 740 5.3558 3.6630 0.9462 1.4448 2.8583 -1.2854 | 750 7.1984 5.1418 1.1157 -1.4641 0.1977 -1.3544 | 760 4.6897 4.3287 1.0263 0.0234 -1.5142 -3.0409 | 770 7.0853 5.9267 1.1504 -1.4608 0.0994 -1.4449 | 780 3.6736 4.3524 0.9269 0.0110 -1.4690 -3.0200 | 790 6.3411 6.3993 1.0971 0.0237 1.6078 -0.1056 | 800 2.5800 4.2287 0.7864 -0.0614 -1.4729 -3.0180 | 810 4.3861 6.3680 0.9001 -0.0503 1.6227 -0.0960 | 820 1.5956 4.2276 0.6479 -0.0899 -1.4200 -3.0033 | 830 3.5088 6.4417 0.8169 -0.0739 1.6532 -0.0852 | 840 0.8805 4.1491 0.6063 -0.0928 -1.4519 -3.0123 | 850 2.6555 6.5699 0.6950 -0.1266 1.6961 -0.1045 | 860 -1.0816 4.5360 0.8102 0.0584 -1.3755 -3.0194 | 870 1.4501 6.5047 0.6224 -0.0124 1.7645 -0.0585 | 880 -1.9693 4.5669 0.7034 0.0544 -1.3594 -3.0361 | 890 0.6726 6.5229 0.5450 -0.0071 1.7885 -0.0805 | 900 -2.8055 4.7069 0.6083 0.1246 -1.2130 -3.0610 | 910 -0.9807 6.2500 0.3701 -0.0220 1.7735 -0.0863 | 930 -2.0990 6.2500 0.2616 -0.0729 1.7309 -0.0822 | 950 -2.9911 6.2500 0.1714 -0.0372 1.7502 -0.0898 | 970 -4.1870 6.2900 0.0224 -0.0475 1.7668 -0.1136 | 420 -5.0845 5.6617 0.0825 -0.0139 1.7455 -0.0909 | 920 -0.4416 4.7809 0.8083 -1.4512 -0.5502 -2.3164 | 940 -3.6010 4.7223 0.5415 0.0175 -1.2847 -3.0586 | 165 -4.7742 -6.1928 0.3612 0.0142 -1.5975 -3.0883 | 175 -4.0484 -6.1824 0.5764 -0.0230 -1.6103 -3.0570 | 185 -4.3860 -6.1914 0.7234 -0.0154 -1.5799 -3.1006 | 260 -4.3200 -6.1847 0.4001 -0.0749 -1.6295 -3.0910 | 70 -3.6715 -6.1423 0.4924 -0.0782 -1.6079 -3.0888 | 195 -3.3361 -6.1036 0.6671 -0.0902 -1.6258 -3.0802 | 295 -2.4215 -6.4644 0.5972 0.0929 -1.7489 -3.1267 | 205 -1.5712 -6.5279 0.6843 0.2269 -1.2840 3.0564 | 250 -1.7254 -3.9844 0.5375 -0.1452 1.4934 -0.1048 | 415 -1.6530 -3.9394 0.6796 -0.0662 1.5524 -0.0122 | 210 -1.1583 -4.0034 0.7370 0.4430 1.7554 -0.1367 | 220 -0.5885 -4.1505 0.7914 0.1075 1.7821 -0.0837 | 240 -1.1500 -3.9500 0.4150 -0.1152 1.5952 -0.0825 | 230 0.4603 -4.3776 0.7889 -0.2600 1.7330 -0.0519 | 225 -0.1529 -6.7880 0.6473 0.1573 -1.7010 -3.1179 | 235 0.6420 -6.9617 0.7056 0.1882 -1.7466 -3.1187 | 245 1.5445 -7.1010 0.6604 0.1287 -1.7056 -3.1228 | 255 2.6264 -7.3468 0.7696 0.0945 -1.5243 -3.1347 | 115 3.7826 -7.1640 0.9207 -0.0761 -1.5664 3.1301 | 270 3.4085 -7.2162 0.7145 -0.0412 -1.4709 -3.0985 | 10 4.0986 -7.1990 0.6038 -0.0615 -1.4627 3.1253 | 80 4.7004 -7.1772 0.6289 -0.0820 -1.5027 3.1359 | 125 4.3358 -7.1414 1.0066 -0.0481 -1.4505 -3.1312 | 135 5.0704 -7.1020 0.5005 -0.0744 -1.4303 -3.1200 | 265 2.5541 -3.7411 0.5873 -0.3095 1.1551 -0.0653 | 145 3.9072 -4.0082 0.7232 0.0654 1.8001 0.0735 | 155 3.4500 -3.9400 0.4220 0.0000 1.5708 -0.0000 | 60 6.9309 -7.0938 0.7017 -0.1585 -1.2493 -3.0772 | 105 6.8885 -7.0282 1.3012 -0.2898 -1.5856 3.1274 | 20 8.3575 -3.4797 1.2760 -1.5321 1.2439 -0.3167 | 30 7.6096 -3.0997 1.0609 -0.0146 1.6092 -0.0268 | 90 7.8013 -4.2394 1.1216 -0.8218 2.1615 0.5196 | 275 7.3429 -2.6801 1.0974 -1.5067 0.7217 -0.8163 | 285 7.3595 -3.0490 1.0783 -1.3885 0.5865 -0.9492 | 305 7.3415 -2.0953 1.0800 -1.5166 0.7552 -0.8021 | 40 8.5823 -4.3250 0.9975 -0.9132 2.1014 0.3959 | 50 8.2403 -5.0535 1.2225 -0.6218 -1.6351 2.7071 | 355 5.3842 -3.0455 1.0336 1.5119 -2.9728 -1.7284 | 365 5.3989 -3.5676 0.9680 1.5230 -2.8293 -1.8802 | 315 5.3334 -1.5519 0.9143 1.4879 -2.9748 -1.6674 | 325 5.3352 -2.0248 1.0085 1.4966 -2.9647 -1.6723 | 345 5.3384 -2.5423 1.0557 1.4953 -2.8677 -1.8141 | 375 6.3817 6.3255 0.8121 -0.0455 1.4747 -0.1528 | 385 5.5957 6.2695 0.6155 -0.0171 1.5782 -0.0711 | 395 4.7619 6.3294 0.7095 -0.0927 1.6622 -0.1409 | 405 -5.6878 5.5363 0.2585 1.5276 1.1994 0.6196 | 425 -3.6670 6.1320 -0.0653 -0.0256 1.7636 -0.1218 | 485 -4.1066 6.1940 -0.2594 0.0087 1.7477 -0.1044 | 435 -3.3494 6.1816 0.0415 -0.0206 1.7436 -0.1136 | 445 -2.8834 6.1428 -0.0869 -0.0247 1.7498 -0.0937 | 455 -2.5578 6.1698 0.0918 -0.0819 1.7733 -0.1014 | 465 -2.0907 6.2574 -0.0459 0.1520 1.6140 -0.0558 | 475 -1.6817 6.3457 0.0675 0.1309 1.6125 -0.0636 | 505 -0.9645 6.1841 0.0600 -0.0220 1.7880 -0.0978 | 525 -0.0572 4.9566 0.6060 0.0950 -1.3949 -3.0452 | 515 -0.3182 4.5763 0.4610 -1.3250 -1.1299 -2.8893 | 535 -1.4992 4.5121 0.5279 0.0473 -1.3603 -3.0459 | 545 -2.3356 4.5348 0.4117 0.0785 -1.3668 -3.0303 | 555 -3.7077 4.5982 0.2508 0.2363 -1.1947 -3.0640 | 695 -4.1815 4.8228 0.4004 0.1914 -1.1062 3.1345 | 605 1.2513 4.1673 0.3651 -0.1162 -1.4566 -3.0026 | 585 0.3937 4.4046 0.5066 1.4230 -2.6510 -1.9714 | 595 0.4357 4.2972 0.2170 1.4295 -2.7990 -1.8233 | 745 2.8837 4.2454 0.6172 -0.1000 -1.3939 -2.9964 | 725 3.3120 4.3448 0.6820 -0.0752 -1.4244 -3.0130 | 715 4.2657 4.3388 0.8135 -0.0097 -1.4947 -3.0135 | 705 3.9170 6.3756 0.6686 -0.0644 1.6091 -0.0905 | 755 2.9669 6.5609 0.4998 -0.0265 1.6490 -0.0777 | 735 1.9550 6.5047 0.4350 -0.0068 1.8023 -0.0525 | 765 1.0582 6.4750 0.3198 -0.0002 1.7931 -0.0496 | 775 0.2787 6.4633 0.2854 0.0053 1.7925 -0.0545 | 565 -4.8313 5.8949 -0.3215 1.4717 2.9469 -1.1789 | 575 -5.0628 5.6094 -0.2193 -0.0114 1.7508 -0.0935 | 495 -4.5423 6.2098 -0.2186 -0.0303 1.6849 -0.1107 | 795 -5.4974 -1.5526 0.4098 -0.2740 1.5195 0.0012 | 805 -5.6218 -2.7182 0.4201 -1.1647 -1.1269 -2.7326 | 645 -5.5754 -3.2398 0.5389 -0.5535 1.6209 -0.1219 | 615 -6.6464 -6.6042 0.6714 0.3474 -1.7977 -3.0668 | 785 -6.9637 -6.4856 0.3003 0.1990 -1.7022 -3.1236 | 625 -6.6030 -6.4817 0.3217 0.2259 -1.6411 -3.1411 | 635 -7.0036 -6.5773 0.6542 0.1986 -1.7366 -3.0888 | 865 4.3756 -4.0370 0.5430 0.0492 1.7510 0.0565 | 875 4.8542 -3.8823 0.8091 0.0104 1.5098 0.0089 | 885 7.3391 -1.6070 1.1201 -1.5063 1.1545 -0.4171 | 895 7.3110 -1.2474 1.1238 -1.4622 1.4561 -0.1055 | 905 7.2600 -0.8700 1.1123 -1.4375 1.3741 -0.1970 " />

      <param name="subscribe_stereo"     type="bool"   value="$(arg stereo)"/>
      <remap from="left/image_rect"        to="/camera/infra1/image_rect_raw"/>
      <remap from="right/image_rect"       to="/camera/infra2/image_rect_raw"/>
      <remap from="left/camera_info"       to="/camera/infra1/camera_info"/>
      <remap from="right/camera_info"      to="/camera/infra2/camera_info"/>

   
      <remap from="rgb/camera_info" to="/camera/color/camera_info"/>
      <remap from="global_pose" to="/global_pose"/>
      <param name="ground_truth_frame_id" type="string" value="world"/>

      <remap from="tag_detections"         to="$(arg tag_topic)"/>
      <!-- <param name="ground_truth_base_frame_id" type="string" value="kinect_gt"/> -->
      <param name="landmark_linear_variance"   type="double" value="$(arg tag_linear_variance)"/>
      <param name="landmark_angular_variance"  type="double" value="$(arg tag_angular_variance)"/>
      
    </node>

    <!-- Visualisation  -->
    <node if="$(arg rtabmap_viz)" pkg="rtabmap_viz" type="rtabmap_viz" name="rtabmap_viz" args="-d $(find rtabmap_examples)/launch/config/rgbd_gui.ini" output="screen">
      <param name="subscribe_depth" type="bool" value="true"/>
      <param name="subscribe_odom_info" type="bool" value="true"/>
      <param name="queue_size" type="int" value="30"/>

      <remap from="rgb/image" to="/camera/color/image_raw"/>
      <!-- <remap from="depth/image" to="/camera/aligned_depth_to_color/image_raw"/> -->
      <remap from="rgb/camera_info" to="/camera/color/camera_info"/>
    </node>

    <node if="$(arg rviz)" pkg="rviz" type="rviz" name="rviz" args="-d $(arg rviz_cfg)"/>

    <!-- Add rosrun python script for diagnostic node -->
    <node name="diagnostic_node" pkg="ghar_ros_common" type="monitor_and_respawn_node.py" output="screen" />


  </group>        

</launch>
