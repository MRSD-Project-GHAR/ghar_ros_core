
<launch>
    <arg name="robot_name"                        default="locobot"/>
    <arg name="rviz"                              default="false"/>
    <arg name="rtabmap_viz"                       default="false"/>
    <arg name="database_path"                     default="~/.ros/rtabmap_nsh_4th.db"/>
    <arg name="localization"                      default="true"/>
    <arg name="delete_db_on_start"                default="true" />
    <arg name="use_sim_time"                      default="false"/>
    <param if="$(arg use_sim_time)" name="use_sim_time" value="true"/>

    <arg name="rtabmap_args"                      default=""/>
    <arg name="rtabmapviz_args"                   default=""/>
    <arg name="frame_id"                          default="camera_link"/>
    <arg name="rviz_cfg"                          default="$(find rtabmap_launch)/launch/config/rgbd.rviz" />
    <arg name="tag_topic"                         default="/tag_detections" />       <!-- apriltags async subscription -->
    <arg name="tag_linear_variance"               default="0.0001" />
    <arg name="tag_angular_variance"              default="9999" />                  <!-- >=9999 means ignore rotation in optimization, when rotation estimation of the tag is not reliable -->
    <arg name="fiducial_topic"                    default="/fiducial_transforms" />  <!-- aruco_detect async subscription, use tag_linear_variance and tag_angular_variance to set covriance -->
    <arg name="stereo"                            default="true"/>
    <!-- TF FRAMES -->
    <!-- Identity Matrix because we fixed the world and map to be the same. Map is not the robot starting poing anymore -->
    <node pkg="tf" type="static_transform_publisher" name="world_to_map"
          args="0.0 0.0 0.0 0.0 0.0 0.0 1.0 /world /map 100" />
      
    <arg name="rtabmap_custom_args" default="$(arg rtabmap_args)
                                            --Optimizer/Strategy 1 
                                            --Optimizer/PriorsIgnored false 
                                            --RGBD/MarkerDetection true
                                            --Marker/Dictionary 16
                                            --Marker/Length 0.25
                                            --RGBD/StartAtOrigin false"/>
                                        
  <group ns="rtabmap">
    <!-- Odometry -->
    <node name="cam_odometry" pkg="rtabmap_odom" type="stereo_odometry" output="screen" respawn="true">
      <remap from="left/image_rect"   to="/camera/infra1/image_rect_raw"/>
      <remap from="right/image_rect"  to="/camera/infra2/image_rect_raw"/>
      <remap from="left/camera_info"  to="/camera/infra1/camera_info"/>
      <remap from="right/camera_info" to="/camera/infra2/camera_info"/>
      <param name="frame_id"          value="camera_link"/>
      <!-- <remap from="imu"               to="/rtabmap/imu"/> -->
      <param name="wait_imu_to_init"  value="false"/>
    </node>

    <!-- Visual SLAM -->
    <node name="rtabmap" pkg="rtabmap_slam" type="rtabmap" output="screen" args="$(arg rtabmap_custom_args)" respawn="true">
      <param name="delete_db_on_start"   value="$(arg delete_db_on_start)"/>
      <param name="database_path"        value="$(arg database_path)"/>
      <param name="localization"         value="$(arg localization)"/>
      <!-- <param name="subscribe_depth" type="bool" value="true"/> -->
      <param name="frame_id" type="string" value="$(arg frame_id)"/>
      <!-- <param name="Marker/Priors" type="string" value="100 -7.1 3.2 0.55 1.5707963 1.5707963 0 | " /> -->
      <!-- Priors we have measured already -->
      <param name="Marker/Priors" type="string" value="100 -7.1 3.2 0.55 1.5707963267948966 0.0 1.5707963267948966|110 -7.10389 2.11046 0.530958 1.5475075336978141 -0.006303120108366428 1.5815666810007796|120 -7.10365 1.20135 0.547947 1.5322815229670022 -0.020109841185035327 1.5769811031127217|130 -7.0957 0.160738 0.534095 1.5317722250607262 -0.016396203945083135 1.584353039597415|140 -7.11922 4.18282 0.566126 1.581207686019172 -0.0695710725180524 1.576526029166689|160 7.22949 3.41187 1.08268 1.692602510480187 0.022072562845198516 -1.5369316453331197|170 5.37027 6.30848 0.979273 1.5006586357159406 -0.10145805523433914 -0.011985344315716172|180 -4.90839 6.17655 0.0533914 1.5091142566031521 0.22832621176881304 1.5849799952645336|200 -0.126788 6.49819 0.481796 1.3465677432484922 -0.0695314528750757 0.012715718700106043|300 -5.68688 -1.19443 0.4648 1.5515157530476675 0.05596594721988259 -1.8550771161145219|310 -5.24641 -0.495153 0.600801 1.5665431684750082 0.08720165359722834 -1.8440887484336148|320 -7.00528 -2.01479 0.566888 1.5316951840466353 -0.0016756716261794558 1.6159206484860404|330 -7.03454 -0.888917 0.530604 1.5133214963256632 0.002834672958273221 1.6155492237253086|350 -6.98292 -3.04619 0.588779 1.5454436267301637 -0.005648070041512273 1.6431607371392838|360 -6.92721 -4.1144 0.568509 1.5435697950494733 -0.009163400206045379 1.6069393022010232|370 -4.80682 -6.21601 0.670475 1.564377210140793 0.04279561512096735 -3.133933898447447|380 -3.88936 -6.21961 0.728487 1.607824788472106 0.041992843298984894 3.1086156605542783|450 -2.94737 -6.35028 0.770325 1.5511668118555626 0.04571734141173517 2.9812698413443646|460 -2.13377 -6.53839 0.726275 1.4971575597019846 -0.0031741339849642313 2.9435964011671976|390 -3.2509 -3.81082 0.725607 1.5556248784835058 -0.023932260262064582 0.049592375820737424|400 -2.08835 -3.90574 0.790643 1.5894453129831418 -0.050865216724746226 0.01103594572051994|410 -1.12674 -3.90284 0.863371 1.5937343033883218 -0.05293461034734226 -0.014880776950069358|420 -0.166102 -3.91528 0.915276 1.5650446153001336 -0.05252232861370498 0.001946646789807806|430 0.621171 -3.92746 0.94795 1.582521597178384 -0.03128406511341188 -0.017462030811324292|440 1.30212 -3.91411 0.981363 1.5553980831796947 -0.028946088433597195 0.03700427767224317|480 2.22428 -3.96046 0.996981 1.4821860344043716 -0.03902126328805578 0.03709583432277893|490 3.22224 -3.96084 1.01721 1.5671431359990027 -0.05397544682031948 0.018086453856946128|530 4.09591 -3.91586 1.07468 1.5179685277513404 -0.04009373709478675 0.030329301528917517|540 5.1114 -3.89805 1.07828 1.5597790259765436 -0.03548126182610748 0.023557821300043604|470 -0.963368 -6.80317 0.75431 1.4902985214122482 0.0018252987805625746 2.862563101156377|500 3.43858 -6.25561 1.15049 1.6146362148501154 0.05018331764144788 -3.139121071018725|510 4.22152 -6.23908 1.19595 1.6042918083447604 0.037431978183387386 -3.119783217356288|520 5.34212 -6.19649 1.17306 1.5535901906098482 0.027850365196307614 -3.1171795449747086|150 7.40242 -5.50005 1.02301 1.6200515293684532 -0.021429176903050243 -1.5374817864432018|550 7.40989 -2.99362 1.09743 1.632307924990361 0.0029957060407028247 -1.5836161280246155|570 7.39462 -2.12557 1.10426 1.6123858431185243 -0.014640030219858042 -1.5757172092146936|560 5.3898 -3.62482 0.984777 1.49307248508606 4.450681801463887e-05 1.5904988426821314|580 5.36588 -2.72716 0.977669 1.5057436277820022 0.007677375331871569 1.5902590837054906|590 7.38308 -1.22599 1.10455 1.6068132055613753 -0.018287966797878242 -1.5778141319334045|600 5.37213 -1.80835 0.992578 1.5178806013767008 0.011775875530665406 1.5796637627774486|610 0.166713 -6.93687 0.804543 1.4600588929052496 0.01936114246568791 2.9862272126560963|620 1.1549 -7.09558 0.815917 1.4517226741913978 0.010415986790206942 2.971776328215584|630 1.95881 -7.20527 0.813068 1.463373993714968 -0.0017781958231032299 2.9762133943785423|640 5.36238 -0.888303 0.985972 1.516881560264551 0.008170517544722535 1.570519331595175|650 7.37914 -0.36937 1.09908 1.6045814674844372 -0.013757807386583092 -1.5901502703145178|660 5.35547 -0.0114234 1.0035 1.498948505789113 0.004575564937497793 1.565382952615724|670 7.36723 0.51738 1.09832 1.6131677963181295 -0.013526814569060285 -1.5670346058213467|680 5.37044 0.846065 1.01277 1.5129215979407928 0.01929804476974777 1.5711646540109683|690 7.40741 1.42137 1.13512 1.6470568542343684 0.018059217368801665 -1.5119738163532543|700 5.37459 1.7885 0.977389 1.4944185857109646 0.01715192379272254 1.5772948413855397|710 7.28112 2.49986 1.08851 1.671314944213971 0.019192583869885742 -1.5215482232378492|720 5.36317 2.7834 0.958921 1.4909602327528375 0.02448272739724604 1.5739189853091573|730 7.18268 4.29767 1.09142 1.679618446100894 0.02132012987547017 -1.5339905353174699|740 5.35577 3.66299 0.946247 1.4498869752406411 4.2670580012963836e-05 1.5354172209860693|750 7.19836 5.14178 1.11574 1.6754486937600845 0.017585763466146122 -1.5479147237780626|760 4.6897 4.3287 1.02631 1.6276845662718449 0.10186954425833661 3.123913761953752|770 7.08527 5.9267 1.15041 1.6802438665964612 0.025789925801340093 -1.5570095902070071|780 3.67365 4.35243 0.926899 1.6733774987891397 0.12205799154375988 -3.140096817501699|790 6.34108 6.39929 1.09713 1.533588203191431 -0.10467309608067457 0.02760097521310171|800 2.57998 4.2287 0.786381 1.669179009302065 0.11704546808588094 -3.0683683524488967|810 4.38613 6.36796 0.900095 1.5186702071934572 -0.0985001999316834 -0.04520439508289821|820 1.59559 4.22761 0.647896 1.7221365851675787 0.12320480464714781 -3.0319558792497245|830 3.50879 6.4417 0.816913 1.4883093453189427 -0.09101269699480337 -0.06658757263851257|840 0.880475 4.14914 0.606333 1.6899744296802848 0.11743914277204438 -3.034155637382904|850 2.65549 6.56986 0.694972 1.4456299540274846 -0.11943293383837414 -0.11256380395032194|860 -1.08161 4.53596 0.810227 1.7674486354414818 0.1312314389757883 3.10810499333357|870 1.45009 6.50466 0.622433 1.3768008960750284 -0.05977551809951507 -0.0008639749483777144|880 -1.96929 4.56688 0.703371 1.7832468919116542 0.11449354123795868 3.110640261788332|890 0.672553 6.52285 0.545044 1.3523867376079746 -0.08010085110385154 0.01049912281846201|900 -2.80553 4.70688 0.60834 1.9283317967622204 0.11904889700727846 3.0529586258718124|910 -0.980689 6.5984 0.370052 1.3673332224106212 -0.08898667001239896 -0.0040869387536137235|920 -0.443963 4.78733 0.8078 1.6634453152810311 -0.2004782177317972 -1.6213967288591844|930 -2.1125 6.48802 0.311256 1.3851865239907062 -0.05837272311472709 0.008624414398078033|940 -2.80553 4.70688 0.60834 1.9283317967622204 0.11904889700727846 3.0529586258718124|950 -3.03599 6.49048 0.229346 1.349908226771956 -0.08170567577841067 -0.002489117269262599|970 -4.24908 6.54147 0.08286 1.3392587081972709 -0.09240695417358032 0.028423886490851556" />

      <param name="subscribe_stereo"     type="bool"   value="$(arg stereo)"/>
      <remap from="left/image_rect"        to="/camera/infra1/image_rect_raw"/>
      <remap from="right/image_rect"       to="/camera/infra2/image_rect_raw"/>
      <remap from="left/camera_info"       to="/camera/infra1/camera_info"/>
      <remap from="right/camera_info"      to="/camera/infra2/camera_info"/>

   
      <remap from="rgb/camera_info" to="/camera/color/camera_info"/>
      <remap from="global_pose" to="/global_pose"/>
      <param name="ground_truth_frame_id" type="string" value="world"/>

      <remap from="tag_detections"         to="$(arg tag_topic)"/>
      <!-- <param name="ground_truth_base_frame_id" type="string" value="kinect_gt"/> -->
      <param name="landmark_linear_variance"   type="double" value="$(arg tag_linear_variance)"/>
      <param name="landmark_angular_variance"  type="double" value="$(arg tag_angular_variance)"/>
      
    </node>

    <!-- Visualisation  -->
    <node if="$(arg rtabmap_viz)" pkg="rtabmap_viz" type="rtabmap_viz" name="rtabmap_viz" args="-d $(find rtabmap_examples)/launch/config/rgbd_gui.ini" output="screen">
      <param name="subscribe_depth" type="bool" value="true"/>
      <param name="subscribe_odom_info" type="bool" value="true"/>
      <param name="queue_size" type="int" value="30"/>

      <remap from="rgb/image" to="/camera/color/image_raw"/>
      <!-- <remap from="depth/image" to="/camera/aligned_depth_to_color/image_raw"/> -->
      <remap from="rgb/camera_info" to="/camera/color/camera_info"/>
    </node>

    <node if="$(arg rviz)" pkg="rviz" type="rviz" name="rviz" args="-d $(arg rviz_cfg)"/>

    <!-- Add rosrun python script for diagnostic node -->
    <node name="diagnostic_node" pkg="ghar_ros_common" type="monitor_and_respawn_node.py" output="screen" />


  </group>        

</launch>
