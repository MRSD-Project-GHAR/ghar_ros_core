
<launch>
    <arg name="robot_name"                        default="locobot"/>
    <arg name="rviz"                              default="false"/>
    <arg name="rtabmap_viz"                       default="false"/>
    <arg name="database_path"                     default="~/.ros/rtabmap_nsh_4th.db"/>
    <arg name="localization"                      default="true"/>
    <arg name="delete_db_on_start"                default="true" />
    <arg name="use_sim_time"                      default="false"/>
    <param if="$(arg use_sim_time)" name="use_sim_time" value="true"/>

    <arg name="rtabmap_args"                      default=""/>
    <arg name="rtabmapviz_args"                   default=""/>
    <arg name="frame_id"                          default="camera_link"/>
    <arg name="rviz_cfg"                          default="$(find rtabmap_launch)/launch/config/rgbd.rviz" />
    <arg name="tag_topic"                         default="/tag_detections" />       <!-- apriltags async subscription -->
    <arg name="tag_linear_variance"               default="0.0001" />
    <arg name="tag_angular_variance"              default="9999" />                  <!-- >=9999 means ignore rotation in optimization, when rotation estimation of the tag is not reliable -->
    <arg name="fiducial_topic"                    default="/fiducial_transforms" />  <!-- aruco_detect async subscription, use tag_linear_variance and tag_angular_variance to set covriance -->

    <!-- TF FRAMES -->
    <!-- Identity Matrix because we fixed the world and map to be the same. Map is not the robot starting poing anymore -->
    <node pkg="tf" type="static_transform_publisher" name="world_to_map"
          args="0.0 0.0 0.0 0.0 0.0 0.0 1.0 /world /map 100" />
      
    <arg name="rtabmap_custom_args" default="$(arg rtabmap_args)
                                            --Optimizer/Strategy 1 
                                            --Optimizer/PriorsIgnored false 
                                            --RGBD/MarkerDetection false
                                            --Marker/Dictionary 16
                                            --Marker/Length 0.25
                                            --RGBD/StartAtOrigin false"/>
    
  <group ns="rtabmap">
    <!-- Odometry -->
    <node name="cam_odometry" pkg="rtabmap_odom" type="rgbd_odometry" output="screen" respawn="true">
      <remap from="rgb/image"       to="/camera/color/image_raw"/>
      <remap from="depth/image"     to="/camera/aligned_depth_to_color/image_raw"/>
      <remap from="rgb/camera_info" to="/camera/color/camera_info"/>
      
      <param name="publish_null_when_lost" value="false"/>
      <param name="Odom/FilteringStrategy" type="string" value="1"/>
      <!-- <param name="Odom/Strategy" type="string" value="5"/> -->
      <param name="frame_id" type="string" value="$(arg frame_id)"/>
    </node>

    <!-- Visual SLAM -->
    <node name="rtabmap" pkg="rtabmap_slam" type="rtabmap" output="screen" args="$(arg rtabmap_custom_args)"  respawn="true">
      <param name="delete_db_on_start"   value="$(arg delete_db_on_start)"/>
      <param name="database_path"        value="$(arg database_path)"/>
      <param name="localization"         value="$(arg localization)"/>
      <param name="subscribe_depth" type="bool" value="true"/>
      <param name="frame_id" type="string" value="$(arg frame_id)"/>
      <!-- <param name="RGBD/CreateOccupancyGrid" type="string" value="false"/> -->
      <!-- <param name="Marker/Priors" type="string" value="100 -7.1 3.2 0.55 1.5707963 1.5707963 0" /> -->
      <!-- Priors we have measured already -->
      <param name="Marker/Priors" type="string" value="100 -7.1000 3.2000 0.5500 1.5708 1.5708 -0.0000 | 110 -7.1039 2.1105 0.5310 1.5452 -2.7137 -2.0051 | 120 -7.1037 1.2013 0.5479 1.5319 -3.0018 -1.7308 | 130 -7.0957 0.1607 0.5341 1.5297 -2.8221 -1.9070 | 140 -7.1192 4.1828 0.5661 1.5586 -0.5559 2.0572 | 160 7.2295 3.4119 1.0827 -1.4451 0.2493 -1.2974 | 170 5.3703 6.3085 0.9793 -0.0191 1.6406 -0.1004 | 180 -4.9084 6.1765 0.0534 1.5045 -2.7038 -1.7807 | 200 -0.1268 6.4982 0.4818 -0.0030 1.7945 -0.0706 | 300 -5.6869 -1.1944 0.4648 -1.2870 -1.6396 3.1315 | 310 -5.2464 -0.4952 0.6008 -1.2978 -1.5865 -3.0695 | 320 -7.0053 -2.0148 0.5669 1.5111 -2.2859 -2.4290 | 330 -7.0345 -0.8889 0.5306 1.4979 -2.4790 -2.2319 | 350 -6.9829 -3.0462 0.5888 1.4943 -1.9087 -2.8102 | 360 -6.9272 -4.1144 0.5685 1.5257 -2.2200 -2.5021 | 370 -4.8068 -6.2160 0.6705 -0.0079 -1.5772 -3.0988 | 380 -3.8894 -6.2196 0.7285 0.0345 -1.5338 -3.1008 | 450 -2.9474 -6.3503 0.7703 0.1594 -1.5907 -3.0927 | 460 -2.1338 -6.5384 0.7263 0.1977 -1.6459 -3.1300 | 390 -3.2509 -3.8108 0.7256 0.0492 1.5860 -0.0247 | 400 -2.0884 -3.9057 0.7906 0.0120 1.5522 -0.0507 | 410 -1.1267 -3.9028 0.8634 -0.0137 1.5479 -0.0533 | 420 -0.1661 -3.9153 0.9153 0.0016 1.5765 -0.0525 | 430 0.6212 -3.9275 0.9479 -0.0171 1.5591 -0.0315 | 440 1.3021 -3.9141 0.9814 0.0366 1.5862 -0.0295 | 480 2.2243 -3.9605 0.9970 0.0335 1.6594 -0.0421 | 490 3.2222 -3.9608 1.0172 0.0179 1.5744 -0.0540 | 530 4.0959 -3.9159 1.0747 0.0282 1.6236 -0.0416 | 540 5.1114 -3.8981 1.0783 0.0232 1.5818 -0.0357 | 470 -0.9634 -6.8032 0.7543 0.2780 -1.6545 -3.1167 | 500 3.4386 -6.2556 1.1505 -0.0003 -1.5270 -3.0913 | 510 4.2215 -6.2391 1.1960 -0.0205 -1.5373 -3.1035 | 520 5.3421 -6.1965 1.1731 -0.0249 -1.5880 -3.1142 | 150 7.4024 -5.5000 1.0230 -1.5108 0.6089 -0.9825 | 550 7.4099 -2.9936 1.0974 -1.5079 -0.2081 -1.7763 | 570 7.3946 -2.1256 1.1043 -1.5290 -0.1032 -1.6888 | 560 5.3898 -3.6248 0.9848 1.4906 -2.8938 -1.8193 | 580 5.3659 -2.7272 0.9777 1.5028 -2.8442 -1.8611 | 590 7.3831 -1.2260 1.1045 -1.5342 -0.1747 -1.7639 | 600 5.3721 -1.8083 0.9926 1.5170 -2.9643 -1.7366 | 610 0.1667 -6.9369 0.8045 0.1523 -1.6828 -3.1051 | 620 1.1549 -7.0956 0.8159 0.1674 -1.6916 -3.1109 | 630 1.9588 -7.2053 0.8131 0.1646 -1.6797 -3.1255 | 640 5.3624 -0.8883 0.9860 1.5169 -3.1386 -1.5656 | 650 7.3791 -0.3694 1.0991 -1.5321 -0.5096 -2.0945 | 660 5.3555 -0.0114 1.0035 1.4988 3.0711 -1.4955 | 670 7.3672 0.5174 1.0983 -1.5282 0.1019 -1.4824 | 680 5.3704 0.8461 1.0128 1.5129 -3.1159 -1.5772 | 690 7.4074 1.4214 1.1351 -1.4754 0.6444 -0.9060 | 700 5.3746 1.7885 0.9774 1.4940 -3.0399 -1.6556 | 710 7.2811 2.4999 1.0885 -1.4598 0.4385 -1.1106 | 720 5.3632 2.7834 0.9589 1.4908 -3.0782 -1.6099 | 730 7.1827 4.2977 1.0914 -1.4567 0.3057 -1.2418 | 740 5.3558 3.6630 0.9462 1.4448 2.8583 -1.2854 | 750 7.1984 5.1418 1.1157 -1.4641 0.1977 -1.3544 | 760 4.6897 4.3287 1.0263 0.0234 -1.5142 -3.0409 | 770 7.0853 5.9267 1.1504 -1.4608 0.0994 -1.4449 | 780 3.6736 4.3524 0.9269 0.0110 -1.4690 -3.0200 | 790 6.3411 6.3993 1.0971 0.0237 1.6078 -0.1056 | 800 2.5800 4.2287 0.7864 -0.0614 -1.4729 -3.0180 | 810 4.3861 6.3680 0.9001 -0.0503 1.6227 -0.0960 | 820 1.5956 4.2276 0.6479 -0.0899 -1.4200 -3.0033 | 830 3.5088 6.4417 0.8169 -0.0739 1.6532 -0.0852 | 840 0.8805 4.1491 0.6063 -0.0928 -1.4519 -3.0123 | 850 2.6555 6.5699 0.6950 -0.1266 1.6961 -0.1045 | 860 -1.0816 4.5360 0.8102 0.0584 -1.3755 -3.0194 | 870 1.4501 6.5047 0.6224 -0.0124 1.7645 -0.0585 | 880 -1.9693 4.5669 0.7034 0.0544 -1.3594 -3.0361 | 890 0.6726 6.5229 0.5450 -0.0071 1.7885 -0.0805 | 900 -2.8055 4.7069 0.6083 0.1246 -1.2130 -3.0610 | 910 -0.9807 6.5984 0.3701 -0.0220 1.7735 -0.0863 | 920 -0.4440 4.7873 0.8078 -1.4745 -0.3389 -2.1125 | 930 -2.1125 6.4880 0.3113 -0.0023 1.7561 -0.0590 | 940 -2.8055 4.7069 0.6083 0.1246 -1.2130 -3.0610 | 950 -3.0360 6.4905 0.2293 -0.0203 1.7910 -0.0792 | 970 -4.2491 6.5415 0.0829 0.0065 1.8013 -0.0964 " />

      <param name="Vis/MinInliers" type="int" value="5"/>
      <remap from="rgb/image" to="/camera/color/image_raw"/>
      <remap from="depth/image" to="/camera/aligned_depth_to_color/image_raw"/>
      <remap from="rgb/camera_info" to="/camera/color/camera_info"/>
      <remap from="global_pose" to="/global_pose"/>
      <param name="ground_truth_frame_id" type="string" value="world"/>

      <remap from="tag_detections"         to="$(arg tag_topic)"/>
      <!-- <param name="ground_truth_base_frame_id" type="string" value="kinect_gt"/> -->
      <param name="landmark_linear_variance"   type="double" value="$(arg tag_linear_variance)"/>
      <param name="landmark_angular_variance"  type="double" value="$(arg tag_angular_variance)"/>
      
    </node>

    <!-- Visualisation  -->
    <node if="$(arg rtabmap_viz)" pkg="rtabmap_viz" type="rtabmap_viz" name="rtabmap_viz" args="-d $(find rtabmap_examples)/launch/config/rgbd_gui.ini" output="screen">
      <param name="subscribe_depth" type="bool" value="true"/>
      <param name="subscribe_odom_info" type="bool" value="true"/>
      <param name="queue_size" type="int" value="30"/>

      <!-- <param name="frame_id" type="string" value="kinect"/> -->

      <remap from="rgb/image" to="/camera/color/image_raw"/>
      <remap from="depth/image" to="/camera/aligned_depth_to_color/image_raw"/>
      <remap from="rgb/camera_info" to="/camera/color/camera_info"/>
    </node>

    <node if="$(arg rviz)" pkg="rviz" type="rviz" name="rviz" args="-d $(arg rviz_cfg)"/>
    <!-- Add rosrun python script for diagnostic node -->
    <node name="diagnostic_node" pkg="ghar_ros_common" type="monitor_and_respawn_node.py" output="screen" />

  </group>        
        <!-- <param name="Optimizer/Strategy"          type="string" value="1"/> -->
        <!-- <param name="Marker/Priors" type="string" value="100 -7.1 3.2 0.55 1.5707963 1.5707963 0" /> -->
        <!-- <arg name="landmark_angular_variance"     type="double" value="9999"/> -->

    <!-- <node pkg="rtabmap" type="rgbd_odometry" name="rgbd_odometry">
        <param name="publish_null_when_lost" value="false"/>
        <param name="Odom/ResetCountdown" value="1"/>
    </node> -->

    <!-- <include file="$(find realsense2_camera)/launch/rs_camera.launch">
        <arg name="align_depth"   value="$(arg depth_mode)"/>
        <arg name="unite_imu_method" value="$(arg unite_imu_method)"/>
        <arg name="enable_gyro"   value="true"/>
        <arg name="enable_accel"  value="true"/>
        <arg name="enable_infra1" value="true"/>
        <arg name="enable_infra2" value="true"/>
        <arg name="gyro_fps"      value="200"/>
        <arg name="accel_fps"     value="250"/>
        <arg name="enable_sync"   value="true"/>
    </include> -->

</launch>
